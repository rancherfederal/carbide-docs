"use strict";(self.webpackChunkcarbide_docs=self.webpackChunkcarbide_docs||[]).push([[68],{7140:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>s,metadata:()=>l,toc:()=>o});var t=n(4848),i=n(8453);const s={},a="Rancher Manager Configuration",l={id:"registry-docs/rancher-config",title:"Rancher Manager Configuration",description:"This page will walk you through how to configure Rancher Manager images instead of the upstream Docker hub images, both for its own components and downstream Rancher Kubernetes clusters (RKE2/K3s).",source:"@site/docs/registry-docs/rancher-config.md",sourceDirName:"registry-docs",slug:"/registry-docs/rancher-config",permalink:"/carbide-docs/docs/registry-docs/rancher-config",draft:!1,unlisted:!1,editUrl:"https://github.com/rancherfederal/carbide-docs/edit/main/docs/registry-docs/rancher-config.md",tags:[],version:"current",frontMatter:{},sidebar:"carbideSidebar",previous:{title:"RKE2/K3s Configuration",permalink:"/carbide-docs/docs/registry-docs/kubernetes-config"},next:{title:"Enforcement",permalink:"/carbide-docs/docs/registry-docs/enforcement"}},c={},o=[{value:"Compatibility Matrix",id:"compatibility-matrix",level:2},{value:"Configuring Cert Manager",id:"configuring-cert-manager",level:2},{value:"Cert Manager Helm Install",id:"cert-manager-helm-install",level:3},{value:"Registry Auth Scenarios",id:"registry-auth-scenarios",level:2},{value:"Global Registry",id:"global-registry",level:3},{value:"Setting a Private Registry with No Credentials as the Default Registry",id:"setting-a-private-registry-with-no-credentials-as-the-default-registry",level:4},{value:"Setting a Private Registry with Credentials when Deploying a Cluster",id:"setting-a-private-registry-with-credentials-when-deploying-a-cluster",level:4},{value:"Manual <code>registries.yaml</code> configuration (<code>RKE2</code>/<code>k3s</code>)",id:"manual-registriesyaml-configuration-rke2k3s",level:3},{value:"<code>registries.yaml</code> Strategy",id:"registriesyaml-strategy",level:4},{value:"Usage with <code>Rancher</code>",id:"usage-with-rancher",level:3},{value:"Example <code>cloud-init</code> (<code>RKE2</code>)",id:"example-cloud-init-rke2",level:4}];function d(e){const r={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(r.h1,{id:"rancher-manager-configuration",children:"Rancher Manager Configuration"}),"\n",(0,t.jsx)(r.p,{children:"This page will walk you through how to configure Rancher Manager images instead of the upstream Docker hub images, both for its own components and downstream Rancher Kubernetes clusters (RKE2/K3s)."}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.strong,{children:"NOTE"}),": Due to current limitations of cloud providers, this project will not work for managing Cloud Provider clusters (AKS, EKS, GKE). If you're currently using Rancher to manage those workloads, do not use this project. We intend to improve this experience in the future."]}),"\n",(0,t.jsx)(r.h2,{id:"compatibility-matrix",children:"Compatibility Matrix"}),"\n",(0,t.jsxs)(r.table,{children:[(0,t.jsx)(r.thead,{children:(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.th,{children:"Infra"}),(0,t.jsx)(r.th,{children:"Provisioner"}),(0,t.jsx)(r.th,{children:"Registry Auth Strategy"}),(0,t.jsx)(r.th,{children:"Test Status"})]})}),(0,t.jsxs)(r.tbody,{children:[(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:"Any"}),(0,t.jsx)(r.td,{children:"Rancher (Cloud provisioner)"}),(0,t.jsx)(r.td,{children:"Global Registry (Rancher)"}),(0,t.jsx)(r.td,{children:"Validated"})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:"Any"}),(0,t.jsx)(r.td,{children:"Rancher (Custom provisioner)"}),(0,t.jsx)(r.td,{children:"Authenticated Registry (Manual registries.yaml)"}),(0,t.jsx)(r.td,{children:"Validated"})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:"Any"}),(0,t.jsx)(r.td,{children:"Self Installation"}),(0,t.jsx)(r.td,{children:"Global Registry (Rancher)"}),(0,t.jsx)(r.td,{children:"Validated"})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:"Any"}),(0,t.jsx)(r.td,{children:"Imported Cluster"}),(0,t.jsx)(r.td,{children:"Unknown"}),(0,t.jsx)(r.td,{})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:"AWS-EKS"}),(0,t.jsx)(r.td,{children:"Rancher"}),(0,t.jsx)(r.td,{children:"ECR (public or private)"}),(0,t.jsx)(r.td,{})]})]})]}),"\n",(0,t.jsx)(r.h2,{id:"configuring-cert-manager",children:"Configuring Cert Manager"}),"\n",(0,t.jsx)(r.p,{children:"As Rancher has a dependency on Cert Manager, you'll need to update your Helm install of Cert Manager to use Carbide Secured Registry (CSR) images that are validated and signed by Rancher Government."}),"\n",(0,t.jsxs)(r.p,{children:["If you're following Rancher's ",(0,t.jsx)(r.a,{href:"https://rancher.com/docs/rancher/v2.6/en/installation/install-rancher-on-k8s/#4-install-cert-manager",children:"Connected"})," installation instructions, you'll need to follow the next steps to use the Carbide Secured Registry (CSR) images for cert-manager."]}),"\n",(0,t.jsxs)(r.p,{children:["If using the ",(0,t.jsx)(r.a,{href:"https://rancher.com/docs/rancher/v2.6/en/installation/other-installation-methods/air-gap/install-rancher/#1-add-the-cert-manager-repo",children:"Airgapped"})," installation instructions, make sure you've pulled the images to your local/airgapped registry."]}),"\n",(0,t.jsx)(r.h3,{id:"cert-manager-helm-install",children:"Cert Manager Helm Install"}),"\n",(0,t.jsxs)(r.p,{children:["Follow Rancher's ",(0,t.jsx)(r.a,{href:"https://rancher.com/docs/rancher/v2.6/en/installation/install-rancher-on-k8s/#4-install-cert-manager",children:"Connected"})," installation instructions, but using the following steps instead of the ",(0,t.jsx)(r.code,{children:"helm install"})," command from the docs."]}),"\n",(0,t.jsxs)(r.p,{children:["After adding the Cert Manager repo and installing the CRDs, use the following to create a temporary ",(0,t.jsx)(r.code,{children:"values.yaml"})," for your chart, subsituting your registry domain:"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{children:"cat <<EOT > /tmp/cert-manager-values.yaml\nimage:\n  registry: <registry-url>\n  repository: jetstack/cert-manager-controller\n\nwebhook:\n  image:\n    registry: <registry-url>\n    repository: jetstack/cert-manager-webhook\n\ncainjector:\n  image:\n    registry: <registry-url>\n    repository: jetstack/cert-manager-cainjector\n\nstartupapicheck:\n  image:\n    registry: <registry-url>\n    repository: jetstack/cert-manager-startupapicheck\n\nacmesolver:\n  image:\n    registry: <registry-url>\n    repository: jetstack/cert-manager-acmesolver\nEOT\n"})}),"\n",(0,t.jsxs)(r.p,{children:["Then use the following ",(0,t.jsx)(r.code,{children:"helm install"})," command to use the images:"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{children:"helm install cert-manager jetstack/cert-manager \\\n  --namespace cert-manager \\\n  --create-namespace \\\n  --version v1.14.4 \\\n  -f /tmp/values.yaml\n"})}),"\n",(0,t.jsx)(r.h2,{id:"registry-auth-scenarios",children:"Registry Auth Scenarios"}),"\n",(0,t.jsx)(r.h3,{id:"global-registry",children:"Global Registry"}),"\n",(0,t.jsx)(r.h4,{id:"setting-a-private-registry-with-no-credentials-as-the-default-registry",children:"Setting a Private Registry with No Credentials as the Default Registry"}),"\n",(0,t.jsxs)(r.ol,{children:["\n",(0,t.jsx)(r.li,{children:"Log into Rancher and configure the default administrator password."}),"\n",(0,t.jsxs)(r.li,{children:["Click ",(0,t.jsx)(r.strong,{children:"\u2630 > Global Settings"}),"."]}),"\n",(0,t.jsxs)(r.li,{children:["Go to the setting called ",(0,t.jsx)(r.code,{children:"system-default-registry"})," and choose ",(0,t.jsx)(r.strong,{children:"\u22ee > Edit Setting"}),"."]}),"\n",(0,t.jsxs)(r.li,{children:["Change the value to your registry (e.g. ",(0,t.jsx)(r.code,{children:"registry.yourdomain.com:port"}),"). Do not prefix the registry with ",(0,t.jsx)(r.code,{children:"http://"})," or ",(0,t.jsx)(r.code,{children:"https://"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.strong,{children:"Result:"})," Rancher will use your private registry to pull system images."]}),"\n",(0,t.jsx)(r.h4,{id:"setting-a-private-registry-with-credentials-when-deploying-a-cluster",children:"Setting a Private Registry with Credentials when Deploying a Cluster"}),"\n",(0,t.jsx)(r.p,{children:"You can follow these steps to configure a private registry when you create a cluster:"}),"\n",(0,t.jsxs)(r.ol,{children:["\n",(0,t.jsxs)(r.li,{children:["Click ",(0,t.jsx)(r.strong,{children:"\u2630 > Cluster Management"}),"."]}),"\n",(0,t.jsxs)(r.li,{children:["On the ",(0,t.jsx)(r.strong,{children:"Clusters"})," page, click ",(0,t.jsx)(r.strong,{children:"Create"}),"."]}),"\n",(0,t.jsx)(r.li,{children:"Choose a cluster type."}),"\n",(0,t.jsxs)(r.li,{children:["In the ",(0,t.jsx)(r.strong,{children:"Cluster Configuration"})," go to the ",(0,t.jsx)(r.strong,{children:"Registries"})," tab and click ",(0,t.jsx)(r.strong,{children:"Pull images for Rancher from a private registry"}),"."]}),"\n",(0,t.jsx)(r.li,{children:"Enter the registry hostname and credentials."}),"\n",(0,t.jsxs)(r.li,{children:["Click ",(0,t.jsx)(r.strong,{children:"Create"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.strong,{children:"Result:"})," The new cluster will be able to pull images from the private registry."]}),"\n",(0,t.jsxs)(r.h3,{id:"manual-registriesyaml-configuration-rke2k3s",children:["Manual ",(0,t.jsx)(r.code,{children:"registries.yaml"})," configuration (",(0,t.jsx)(r.code,{children:"RKE2"}),"/",(0,t.jsx)(r.code,{children:"k3s"}),")"]}),"\n",(0,t.jsxs)(r.p,{children:["In order to configure authentication to the CRI ",(0,t.jsx)(r.em,{children:"before"})," pulling down the base kubernetes container image. To modify the system images that ",(0,t.jsx)(r.code,{children:"k3s"})," or ",(0,t.jsx)(r.code,{children:"rke2"})," uses upon bootstrapping, configure k3s' mirror settings as described ",(0,t.jsx)(r.a,{href:"https://rancher.com/docs/k3s/latest/en/installation/private-registry/#mirrors",children:"here"}),"."]}),"\n",(0,t.jsx)(r.p,{children:"The full configuration using the shared alpha account is below:"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-yaml",children:'# /etc/rancher/k3s/registries.yaml\n# /etc/rancher/rke2/registries.yaml\nmirrors:\n  docker.io:\n    endpoint:\n      - "https://<registry-url>"\n\nconfigs:\n  "<registry-url>":\n    auth:\n      username: <redacted>\n      password: <redacted>\n'})}),"\n",(0,t.jsxs)(r.h4,{id:"registriesyaml-strategy",children:[(0,t.jsx)(r.code,{children:"registries.yaml"})," Strategy"]}),"\n",(0,t.jsxs)(r.table,{children:[(0,t.jsx)(r.thead,{children:(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.th,{children:"Scenario"}),(0,t.jsx)(r.th,{children:"Best practice"})]})}),(0,t.jsxs)(r.tbody,{children:[(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:"Use of a 'golden image'"}),(0,t.jsxs)(r.td,{children:["Pre-configure ",(0,t.jsx)(r.code,{children:"registries.yaml"})," on golden image before host provisioning"]})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:"Rancher provisioned cluster"}),(0,t.jsxs)(r.td,{children:["Embed a ",(0,t.jsx)(r.code,{children:"cloud-init"})," file into cluster provisioning (Example below)"]})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:"Ansible/Saltstack/Manual"}),(0,t.jsxs)(r.td,{children:["Pre-configure ",(0,t.jsx)(r.code,{children:"registries.yaml"})," on host before cluster provisioning"]})]})]})]}),"\n",(0,t.jsxs)(r.h3,{id:"usage-with-rancher",children:["Usage with ",(0,t.jsx)(r.code,{children:"Rancher"})]}),"\n",(0,t.jsxs)(r.p,{children:["Follow Rancher's ",(0,t.jsx)(r.a,{href:"https://rancher.com/docs/rancher/v2.5/en/installation/install-rancher-on-k8s",children:"Installation Guide"}),", adding in the following steps to use our ",(0,t.jsx)(r.a,{href:"https://github.com/rancherfederal/carbide-charts",children:"Carbide Helm Chart"})," and the ",(0,t.jsx)(r.code,{children:"helm install"})," command."]}),"\n",(0,t.jsx)(r.p,{children:"When installing Rancher, to utilize the private registry, you'll need to set the following values in your Helm values:"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:"helm repo add carbide-charts https://rancherfederal.github.io/carbide-charts\nhelm repo update\nhelm search repo carbide-charts\n\nhelm install rancher carbide-charts/rancher \\\n  --namespace cattle-system \\\n  --set hostname=rancher.my.org \\\n  --set replicas=3 \\\n  --set rancherImage=<registry-url>/rancher/rancher\n  --set systemDefaultRegistry=<registry-url>\n"})}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.strong,{children:"NOTE:"})," This requires configuring your above K3s/RKE2 ",(0,t.jsx)(r.code,{children:"registries.yaml"})," to work."]}),"\n",(0,t.jsxs)(r.h4,{id:"example-cloud-init-rke2",children:["Example ",(0,t.jsx)(r.code,{children:"cloud-init"})," (",(0,t.jsx)(r.code,{children:"RKE2"}),")"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-yaml",children:'# cloud-init\n\nruncmd:\n  - mkdir /etc/rancher/rke2\nwrite_files:\n  - path: /etc/rancher/rke2/registries.yaml\n    content: |\n      mirrors:\n        docker.io:\n            endpoint:\n            - "https://<registry-url>"\n\n        configs:\n        "<registry-url>":\n            auth:\n            username: <redacted>\n            password: <redacted>\n    permissions: \'0644\'\n'})})]})}function h(e={}){const{wrapper:r}={...(0,i.R)(),...e.components};return r?(0,t.jsx)(r,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},8453:(e,r,n)=>{n.d(r,{R:()=>a,x:()=>l});var t=n(6540);const i={},s=t.createContext(i);function a(e){const r=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function l(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),t.createElement(s.Provider,{value:r},e.children)}}}]);