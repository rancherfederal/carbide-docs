"use strict";(self.webpackChunkcarbide_docs=self.webpackChunkcarbide_docs||[]).push([[882],{950:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>u,frontMatter:()=>a,metadata:()=>s,toc:()=>c});var t=r(4848),i=r(8453);const a={},o="Enforcement",s={id:"registry-docs/enforcement",title:"Enforcement",description:"This page will walk you through configuring Policy Enforcement (Kubewarden, Kyverno, Open Policy Agent) to ensure images running in your cluster that come from the hardened registry are validated against our public key before deploying.",source:"@site/docs/registry-docs/enforcement.md",sourceDirName:"registry-docs",slug:"/registry-docs/enforcement",permalink:"/carbide-docs/docs/registry-docs/enforcement",draft:!1,unlisted:!1,editUrl:"https://github.com/rancherfederal/carbide-docs/edit/main/docs/registry-docs/enforcement.md",tags:[],version:"current",frontMatter:{},sidebar:"carbideSidebar",previous:{title:"Rancher Manager Configuration",permalink:"/carbide-docs/docs/registry-docs/rancher-config"},next:{title:"RKE2/K3s Uninstall",permalink:"/carbide-docs/docs/registry-docs/uninstall-kubernetes"}},l={},c=[{value:"Kubewarden Enforcement",id:"kubewarden-enforcement",level:2},{value:"Installation",id:"installation",level:3},{value:"Private Registry",id:"private-registry",level:3},{value:"Copying Policy Artifact to a Registry (Connected Environments)",id:"copying-policy-artifact-to-a-registry-connected-environments",level:3},{value:"Saving Policy Artifact (Airgaped Environments)",id:"saving-policy-artifact-airgaped-environments",level:3},{value:"Loading Policy Artifact to a Registry (Airgaped Environments)",id:"loading-policy-artifact-to-a-registry-airgaped-environments",level:3},{value:"Creating the Policy",id:"creating-the-policy",level:3},{value:"Kyverno Enforcement",id:"kyverno-enforcement",level:2},{value:"Installation",id:"installation-1",level:3},{value:"Private Registry",id:"private-registry-1",level:3},{value:"Creating the Policy",id:"creating-the-policy-1",level:3},{value:"OPA Gatekeeper Enforcement",id:"opa-gatekeeper-enforcement",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"enforcement",children:"Enforcement"}),"\n",(0,t.jsx)(n.p,{children:"This page will walk you through configuring Policy Enforcement (Kubewarden, Kyverno, Open Policy Agent) to ensure images running in your cluster that come from the hardened registry are validated against our public key before deploying."}),"\n",(0,t.jsx)(n.h2,{id:"kubewarden-enforcement",children:"Kubewarden Enforcement"}),"\n",(0,t.jsx)(n.h3,{id:"installation",children:"Installation"}),"\n",(0,t.jsx)(n.p,{children:"To install Kubewarden, run the following commands, substituting your registry information:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# add and update the helm chart repository\nhelm repo add kubewarden https://charts.kubewarden.io\nhelm repo update\n\n# install the crds helm chart\nhelm install --wait -n kubewarden --create-namespace kubewarden-crds kubewarden/kubewarden-crds\n\n# install the controller helm chart\nhelm install --wait -n kubewarden kubewarden-controller kubewarden/kubewarden-controller --set "common.cattle.systemDefaultRegistry=<registry-url>"\n\n# install the defaults helm chart\nhelm install --wait -n kubewarden kubewarden-defaults kubewarden/kubewarden-defaults --set "common.cattle.systemDefaultRegistry=<registry-url>" kubewarden/kubewarden-defaults\n'})}),"\n",(0,t.jsxs)(n.p,{children:["For more information about installing Kubewarden, see the ",(0,t.jsx)(n.a,{href:"https://docs.kubewarden.io/quick-start#installation",children:"docs"}),"."]}),"\n",(0,t.jsx)(n.h3,{id:"private-registry",children:"Private Registry"}),"\n",(0,t.jsxs)(n.p,{children:["If your Rancher system images are in a private registry requiring authentication, you'll need to configure your Kubewarden policy-server with a ",(0,t.jsx)(n.a,{href:"https://docs.kubewarden.io/operator-manual/policy-servers/private-registry",children:"Pull Secret"})," in order for it to validate the signature."]}),"\n",(0,t.jsx)(n.h3,{id:"copying-policy-artifact-to-a-registry-connected-environments",children:"Copying Policy Artifact to a Registry (Connected Environments)"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# authenticate into carbide secured registry\nhauler login -u <redacted> -p <redacted> rgcrprod.azurecr.us\n\n# download the public key for carbide\ncurl -sfOL https://raw.githubusercontent.com/rancherfederal/carbide-releases/main/carbide-key.pub\n\n# fetch the image from the carbide secured registry\nhauler store add image rgcrprod.azurecr.us/policies/verify-image-signatures:v0.1.7 --key carbide-key.pub --platform linux/amd64\n\n# copy the content from the hauler store to your registry\nhauler store copy --username <redacted> --password <redacted> registry://<registry-url>\n"})}),"\n",(0,t.jsx)(n.h3,{id:"saving-policy-artifact-airgaped-environments",children:"Saving Policy Artifact (Airgaped Environments)"}),"\n",(0,t.jsx)(n.p,{children:"Use the below script, substituting your registry, to both validate and save locally the policy artifact:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# authenticate into carbide secured registry\nhauler login -u <redacted> -p <redacted> rgcrprod.azurecr.us\n\n# download the public key for carbide\ncurl -sfOL https://raw.githubusercontent.com/rancherfederal/carbide-releases/main/carbide-key.pub\n\n# fetch the image from the carbide secured registry\nhauler store add image rgcrprod.azurecr.us/policies/verify-image-signatures:v0.1.7 --key carbide-key.pub --platform linux/amd64\n\n# save and output the content from the hauler store to tarball\nhauler store save --filename kubewarden-policy.tar.zst\n"})}),"\n",(0,t.jsx)(n.h3,{id:"loading-policy-artifact-to-a-registry-airgaped-environments",children:"Loading Policy Artifact to a Registry (Airgaped Environments)"}),"\n",(0,t.jsx)(n.p,{children:"Use the below script, substituting your registry, to load the policy artifact:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# load the content from the tarball to the hauler store\nhauler store load kubewarden-policy.tar.zst\n\n# copy the content from the hauler store to your registry\nhauler store copy --username <redacted> --password <redacted> registry://<registry-url>\n"})}),"\n",(0,t.jsx)(n.h3,{id:"creating-the-policy",children:"Creating the Policy"}),"\n",(0,t.jsxs)(n.p,{children:["After installing/configuring Kubewarden and copying the policy to your registry, apply the following ClusterAdmissionPolicy (substituting ",(0,t.jsx)(n.code,{children:"<registry-url>"})," with your registry domain):"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"apiVersion: policies.kubewarden.io/v1\nkind: ClusterAdmissionPolicy\nmetadata:\n  name: verify-image-signatures\nspec:\n  module: <registry-url>/policies/verify-image-signatures:v0.1.7\n  rules:\n    - apiGroups: ['', 'apps', 'batch']\n      apiVersions: ['v1']\n      resources:\n        [\n          'pods',\n          'deployments',\n          'statefulsets',\n          'replicationcontrollers',\n          'jobs',\n          'cronjobs',\n        ]\n      operations:\n        - CREATE\n        - UPDATE\n  mutating: true\n  settings:\n    signatures:\n      - image: '<registry-url>/carbide/*'\n        pubKeys:\n          - |\n            -----BEGIN PUBLIC KEY-----\n            MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE5zlXeLmRxBHbVmDRZpnCFdzKhyKO\n            tCAZva7CLlk/6gxvCM0QkIKznfaGTRMMYTaHMdQSau6yulDLlpokA++i8Q==\n            -----END PUBLIC KEY-----\n      - image: '<registry-url>/jetstack/*'\n        pubKeys:\n          - |\n            -----BEGIN PUBLIC KEY-----\n            MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE5zlXeLmRxBHbVmDRZpnCFdzKhyKO\n            tCAZva7CLlk/6gxvCM0QkIKznfaGTRMMYTaHMdQSau6yulDLlpokA++i8Q==\n            -----END PUBLIC KEY-----\n      - image: '<registry-url>/rancher/*'\n        pubKeys:\n          - |\n            -----BEGIN PUBLIC KEY-----\n            MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE5zlXeLmRxBHbVmDRZpnCFdzKhyKO\n            tCAZva7CLlk/6gxvCM0QkIKznfaGTRMMYTaHMdQSau6yulDLlpokA++i8Q==\n            -----END PUBLIC KEY-----\n      - image: '<registry-url>/longhornio/*'\n        pubKeys:\n          - |\n            -----BEGIN PUBLIC KEY-----\n            MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE5zlXeLmRxBHbVmDRZpnCFdzKhyKO\n            tCAZva7CLlk/6gxvCM0QkIKznfaGTRMMYTaHMdQSau6yulDLlpokA++i8Q==\n            -----END PUBLIC KEY-----\n      - image: '<registry-url>/neuvector/*'\n        pubKeys:\n          - |\n            -----BEGIN PUBLIC KEY-----\n            MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE5zlXeLmRxBHbVmDRZpnCFdzKhyKO\n            tCAZva7CLlk/6gxvCM0QkIKznfaGTRMMYTaHMdQSau6yulDLlpokA++i8Q==\n            -----END PUBLIC KEY-----\n"})}),"\n",(0,t.jsx)(n.h2,{id:"kyverno-enforcement",children:"Kyverno Enforcement"}),"\n",(0,t.jsx)(n.h3,{id:"installation-1",children:"Installation"}),"\n",(0,t.jsxs)(n.p,{children:["See the docs on how to install ",(0,t.jsx)(n.a,{href:"https://kyverno.io/docs/installation",children:"Kyverno"})," onto your cluster."]}),"\n",(0,t.jsx)(n.h3,{id:"private-registry-1",children:"Private Registry"}),"\n",(0,t.jsxs)(n.p,{children:["If your Rancher system images are in a private registry requiring authentication, you'll need to configure your Kyverno policy-server with a ",(0,t.jsx)(n.a,{href:"https://kyverno.io/policies/other/require_imagepullsecrets/require_imagepullsecrets",children:"Pull Secret"})," in order for it to validate the signature."]}),"\n",(0,t.jsx)(n.h3,{id:"creating-the-policy-1",children:"Creating the Policy"}),"\n",(0,t.jsxs)(n.p,{children:["After installing/configuring Kyverno, apply the following Policy (substituting ",(0,t.jsx)(n.code,{children:"<registry-url>"})," with your registry domain):"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"apiVersion: kyverno.io/v1\nkind: Policy\nmetadata:\n  name: verify-image-signatures\nspec:\n  validationFailureAction: enforce\n  background: false\n  webhookTimeoutSeconds: 30\n  failurePolicy: Fail\n  rules:\n    - name: check-image\n      match:\n        any:\n          - resources:\n              kinds:\n                - Pod\n                - Deployment\n      verifyImages:\n        - imageReferences:\n            - '<registry-url>/carbide/*'\n            - '<registry-url>/jetstack/*'\n            - '<registry-url>/rancher/*'\n            - '<registry-url>/longhornio/*'\n            - '<registry-url>/neuvector/*'\n          attestors:\n            - count: 1\n              entries:\n                - keys:\n                    publicKeys: |-\n                      -----BEGIN PUBLIC KEY-----\n                      MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE5zlXeLmRxBHbVmDRZpnCFdzKhyKO\n                      tCAZva7CLlk/6gxvCM0QkIKznfaGTRMMYTaHMdQSau6yulDLlpokA++i8Q==\n                      -----END PUBLIC KEY-----\n"})}),"\n",(0,t.jsx)(n.h2,{id:"opa-gatekeeper-enforcement",children:"OPA Gatekeeper Enforcement"}),"\n",(0,t.jsxs)(n.p,{children:["Gatekeeper can be used to verify image signatures through its ",(0,t.jsx)(n.a,{href:"https://open-policy-agent.github.io/gatekeeper/website/docs/externaldata",children:"External Data Provider"}),"."]})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>o,x:()=>s});var t=r(6540);const i={},a=t.createContext(i);function o(e){const n=t.useContext(a);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);